---
title: "R Notebook"
output: html_notebook
---

## Sour Cream

Interesting facts not relevant to subquestions directly:

-   as we have only one sample per combination of factors, we should not test for interactions. However, we can still test for main effects.

### a)

Analyze the data in a three-way experiment without interactions with acidity as response and starter, batch and position as factors. By using summary command, can you tell whether there is a significant difference between the effects of starter 1 and starter 2 on acidity? Motivate your answer.

```{r}
data <- read.csv("data/cream.txt", sep="", header=TRUE)
cream_treatment <- data.frame(acidity=data[,1], batch=factor(data[,2]), position=factor(data[,3]), starter=factor(data[,4]))

creamaov_treatment <- lm(acidity ~ batch + position + starter, data=cream_treatment)

# Visual normality check
qqnorm(residuals(creamaov_treatment))
plot(fitted(creamaov_treatment), residuals(creamaov_treatment))

anova(creamaov_treatment)
summary(creamaov_treatment)

starter_difference_p_value <- summary(creamaov_treatment)$coefficients[10,4]
```

We perform a three-way ANOVA using treatment parameterization. To ensure our ANOVA results are valid, we inspect the QQ plot as well as fitted vs. residual plot to ensure normality. We pass this test based on the distribution visible there. We then look at the ANOVA coefficients to determine the significance of the means of our baseline scenario representing **starter1** and the level **starter2** sharing the same mean. As the p-value is `r starter_difference_p_value`, we presume that there is no significant difference between the effect of the two starters on acidity and assume they stem from the same distribution.

$$\alpha_{1} = 0 \land \alpha_{2} = 0 \implies \mu_{starter=1}=\mu_{starter=2}  \text{ (for treatment parameterization) }$$

### b)

Recall that the main interest is in the effect of starter on acidity; factors position and batch represent the block variables. Remove insignificant block variable(s) if there are such, and perform an ANOVA for the resulting “fixed effects” model. Which starter(s) lead to significantly different acidity? Motivate your answer.

```{r}
cream_sum <- data.frame(acidity=data[,1], batch=factor(data[,2]), position=factor(data[,3]), starter=factor(data[,4]))
contrasts(cream_sum$batch) <- contr.sum
contrasts(cream_sum$position) <- contr.sum
contrasts(cream_sum$starter) <- contr.sum

creamaov_sum <- lm(acidity ~ batch + position + starter, data=cream_sum)
anova(creamaov_sum)
summary(creamaov_sum)

p_value_batch <- anova(creamaov_sum)$'Pr(>F)'[1]
p_value_position <- anova(creamaov_sum)$'Pr(>F)'[2]
p_value_starter <- anova(creamaov_sum)$'Pr(>F)'[3]
p_value_batch3 <- summary(creamaov_sum)$coefficients[3,4]
```

```{r}
creamaov_fixed_sum <- lm(acidity ~ batch + starter, data=cream_sum)
# TODO: check if we are setting the right things to be factors. Block variables shouldn't be set to be factors I think? See Lecture 6 Slide 24
# TODO: supposedly everything is balanced here???
# we place factor of interest starter last because treatment factors needs to come last. That's because the order is important if model is unbalanced (unsure, maybe the case here?) or for 2 continuous factors (not relevant here)
# TODO: we could use drop1 to re-run all combinations so that the p-values will all be right

# Visual normality check
qqnorm(residuals(creamaov_fixed_sum))
plot(fitted(creamaov_fixed_sum), residuals(creamaov_fixed_sum))

anova(creamaov_fixed_sum)
summary(creamaov_fixed_sum)
```
Looking at the first sum parameterization ANOVA table using the full model, we find that the p-value for the factor *position* is `r p_value_position` and all its individual levels have coefficients corresponding to a p-value larger than `0.05` stating the lack of significance as main effect for the model. Due to the small size of the dataset, we are unable to thoroughly test for interactions, thus we will assume them to be negligible. In this case, we can remove the block variable *position* from the model to simplify.

As the *batch* variable has a factor p-value of `r p_value_batch` we can conclude that it is significant for the model and should be kept in our fixed effects model, further substantiated by a particularly deviating instance of **batch2** with p-value `r p_value_batch3`.

The resulting fixed effects model formula therefore becomes `acidity ~ starter + batch` ignoring interactions. In this model, we find that **starter3** and **starter4** have a very significant effect on acidity with p-values both below `0.001`.

# *TODO: What about starter5 in the sum paramterization model? What are we comparing here again? Double-check this makes sense.*

```{r}
creamaov_sum_auto <- step(creamaov_sum)

# Visual normality check
qqnorm(residuals(creamaov_sum_auto))
plot(fitted(creamaov_sum_auto), residuals(creamaov_sum_auto))

anova(creamaov_sum_auto)
summary(creamaov_sum_auto)
```

Utilizing the step function utility in its default configuration further substantiates our previous results as the algorithm also removed the insignificant block variable *position* from the model. The resulting model of the algorithm is the same as the one we have established manually above.

### c)

For the resulting model from c), can we also apply the Friedman test to test whether there is an effect of starter on acidity?

```{r}
friedman.test(acidity ~ starter | position, data=cream_sum) # alternative syntax
# friedman.test(cream_sum$acidity, cream_sum$starter, cream_sum$position)
```

Since each combination of batch and starter exists in the dataset and there are more than two levels of both factors, we can apply the Friedman test to test whether there is an effect of starter on acidity. The Friedman test does not assume normality either so it should be more robust, albeit less sensitive.

The p-value of the Friedman test is `0.0755` which is slightly lower than the significance threshold of `0.05` and therefore we accept the null hypothesis that all means stem from the same distribution. So according to the Friedman test, we would conclude that there is no significant effect of starter on acidity. This result may be due to the small sample size and the test's lack of sensitivity. The ANOVA test should provide us with more relevant insight, but this is a result worthy to be further investigated to check our methods.

# *TODO: What is the difference between the Friedman test and the ANOVA test? Why do we get different results? Are we ignoring batch? Are we maybe not allowed to use it for some reason?*

### d)

Repeat c) by performing a mixed effects analysis, modeling the block variable(s) (if there are any) as a random effect by using the function lmer. (You will need to install the R-package lme4, which is not included in the standard distribution of R.) Compare your results to the results found by using the fixed effects model in c). Comment.

```{r}
library(lme4)
mixedaov <- lmer(acidity ~ batch + starter + (1|position), data=cream_sum)
mixedaov_excluded <- lmer(acidity ~ batch + (1|position), data=cream_sum)

# Visual normality check
qqnorm(residuals(mixedaov))
plot(fitted(mixedaov), residuals(mixedaov))

qqnorm(residuals(mixedaov_excluded))
plot(fitted(mixedaov_excluded), residuals(mixedaov_excluded))

anova(mixedaov_excluded, mixedaov)
p_significant <- anova(mixedaov_excluded, mixedaov)$'Pr(>Chisq)'[2]
```

Using **`(1|position)`**, we allow the intercepts of the model to vary randomly across different levels of the factor *position*. Comparing the mixed model without *starter* with the one including *starter* using ANOVA we get a p-value of `r p_significant`` which is significant so we confirm our previous ANOVA results and assumptions that *starter* is a relevant factor for *acidity*. Particularly noteworthy is the high significance of our result using the mixed model compared to the low significance of the Friedman test.
