---
title: "Assignment 2 - Exercise 1"
output: html_notebook
---

## Exercise 1. Fruit Flies

In this section, we investigate the effect of sexual activity on longevity of fruit flies. First, we add a column called **loglongevity** to the data frame, containing the logarithm of the number of days until death (**longevity** column). We will use this as our response variable and further discuss this decision later in the report. We also use the *isolated* group as the baseline for the **activity** factor.

```{r, echo=FALSE}
library(visreg)
library(car)
set.seed(10)
```

```{r, results='hide'}
ff <- read.table("data/fruitflies.txt", header=TRUE)
ff$loglongevity <- log(ff$longevity, base=exp(1))
ff$activity <- factor(ff$activity, levels=c("isolated", "low", "high"))
summary(ff)
```

a)  

We first investigate the data through plots, checking for normality and gathering intel whether sexual activity may influencs longevity. We also perform a Levene test to check for homogeneity of variances between the three sexual activity groups.

```{r, fig.width=7.2, fig.height=2.8}
par(mfrow=c(1,3))
hist(ff$loglongevity, main="Histogram of Log-Longevity", xlab="Log-Longevity", col="lightblue")
qqnorm(ff$loglongevity, main="Normal Q-Q Plot of Log-Longevity")
boxplot(loglongevity ~ activity, data=ff, main="Log-Longevity by sexual acitivity", col="lightblue", xlab="Sexual activity", ylab="Log-Longevity")
p_levene <- leveneTest(loglongevity ~ activity, data=ff)[1,3]
```

By inspecting the histogram, we notice that **loglongevity** is slightly right-shifted due to the logarithmic mapping. The Q-Q plot however still shows approximately normal distribution. As the Levene test returns a p-value of `r round(p_levene, 4)` $> 0.05$ we assume homogeneous variances and conclude that we are able to perform ANOVA to further assess whether **sexual activity** influences **loglongevity**. We first do this without taking the **thorax** (length) into account. The boxplot provides first hints that the **loglongevit**y range and its mean are higher for the *isolated* group and seem to decrease increasingly for the *low* and *high* **sexual activity** groups.

```{r, results='hide'}
ff_aov <- lm(loglongevity ~ activity, data=ff)
anova(ff_aov)
summary(ff_aov)
p_activity <- summary(ff_aov)$coefficients[2,4]

loglongev_by_activity <- tapply(ff$loglongevity, ff$activity, mean)
longev_by_activity <- exp(loglongev_by_activity)
p_baseline_low <- summary(ff_aov)$coefficients[2,4]
```

The ANOVA strongly suggests that there is a statistically significant difference in log-longevity between the three **activity** levels *isolated*, *low* and *high* with p=`r round(p_activity, 4)`, confirming our first intuition. While deviations between our baseline and the *low* activity group aren't significant with p=`r round(p_baseline_low, 4)`, the *high* activity group has substantial deviations from the baseline mean. The estimated mean **loglongevities** for the three sexual activity groups in order are `r loglongev_by_activity[1]`, `r loglongev_by_activity[2]` and `r loglongev_by_activity[3]`. Non-log values are `r longev_by_activity[1]`, `r longev_by_activity[2]` and `r longev_by_activity[3]`, respectively.

b)  

We continue our analysis by including the numerical explanatory variable *thorax* (length) by extending our prior analysis using ANCOVA.

```{r, results='hide'}
ff_aocv2 <- lm(loglongevity ~ thorax + activity, data=ff)
anova(ff_aocv2)
summary(ff_aocv2)
p_activity <- anova(ff_aocv2)$'Pr(>F)'[2]

mean_thorax <- mean(ff$thorax)
mean_thorax_ff <- data.frame(thorax=mean_thorax, activity=levels(ff$activity))
pred_loglongev <- predict(ff_aocv2, newdata=mean_thorax_ff)
```

Here, we confirm again that sexual **activity** is a significant factor with p=`r round(p_activity, 4)`. We can notice its effect of decreasing longevity with increasing activity based also on our predictions for the three **activity** groups when fixing **thorax** length of the dataset to its mean. The estimated mean **loglongevities** for the three sexual **activity** groups in order are `r pred_loglongev[1]` (*isolated*), `r pred_loglongev[2]` (*low*) and `r pred_loglongev[3]` (*high*).

c)

Following, we investigate the influence of **thorax** length on **loglongevity**. First, we perform a linear regression to visually inspect the potential relationship between the two variables, amongst others checking for differences in the slopes of the regression lines for the three sexual **activity** groups.

```{r, results='hide'}
par(mar=c(5, 5, 2, 2))
colors = c("black", "orange", "red")

# Color-coded scatter plot for activities
plot(ff$thorax, ff$loglongevity, 
     xlab="Thorax Length", ylab="Logarithm of Longevity",
     main="Mean and STD of Log-Longevity vs Thorax Length by Sexual Activity",
     col=colors[as.numeric(factor(ff$activity))], pch=16)

# Legend
legend("topleft", legend=levels(ff$activity), 
       col=colors, pch=16, title="Activity")

# Regression lines and confidence intervals
models <- list()
for (act in unique(ff$activity)) {
  subset_ff <- subset(ff, activity==act)
  model <- lm(loglongevity ~ thorax, data=subset_ff)
  models[[act]] <- model
  abline(model, col=colors[which(levels(ff$activity)==act)], lty=2)
  preds <- predict(model, interval="confidence", level=0.95)
  polygon(c(subset_ff$thorax, rev(subset_ff$thorax)),
          c(preds[, "lwr"], rev(preds[, "upr"])), border=NA,
          col=adjustcolor(colors[which(levels(ff$activity)==act)], alpha.f=0.3))
}

ancova_model <- lm(loglongevity ~ thorax * activity, data=ff)
# visreg(ancova_model, "thorax", "activity") # alternative one-liner
anova(ancova_model)
summary(ancova_model)
p_interaction <- summary(ancova_model)$coefficients[4,4]
p_thorax <- summary(ancova_model)$coefficients[2,4]
```

By visually inspecting mean and standard deviation of the linear regression modles, we assume that **thorax** length has an influence on **loglongevity**, although the difference between the *low* and *isolated* groups is small and perhaps negligible. Performing an ANCOVA, we find that the interaction between **thorax** length and **activity** are not quite significant enough with p=`r round(p_interaction, 4)`. ANCOVA results suggest that **thorax** length has a significant positive influence on **loglongevity** with p=`r round(p_thorax, 4)` and this relationship appears to be consistent across different levels of sexual **activity**.

d)

We prefer the analysis with **thorax** length, as it provides a more complete picture of the relationship between sexual **activity**, **thorax** length, and **loglongevity**. If one is solely interested in the influence of sexual **activity** on **loglongevity** or has prior information on variable relationships, then the analysis excluding **thorax** length is sufficient. However, it is incomplete and simplified which could cause issues if **thorax** length has a substantial hidden contribution due to interaction with sexual **activity**. Therefore, for a more comprehensive overview, the analysis including **thorax** length is preferred.

e)  

We now analyze the decision to use the logarithm of **longevity** as response variable by comparings ANCOVA results.

```{r, results='hide'}
ancova_model2 <- lm(longevity ~ thorax * activity, data=ff)
anova(ancova_model2)
summary(ancova_model2)
leveneTest(longevity ~ activity, data=ff)
```

In the case of analyzing the true **longevity** value, no major changes in our interpretations of the results of ANCOVA are observed. We would not state that the baseline and *high* activity group have significant differences in **longevity**. However, the **thorax** length still has a significant positive influence on **longevity**. Levene tests and normality checks are still valid. Arguably, normality is clearer for the original *longevity* values.